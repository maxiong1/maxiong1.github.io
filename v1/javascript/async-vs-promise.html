<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>async vs promise | 熊大</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/v1/icons/favicon.ico">
    <meta name="description" content="了解为什么async/await是处理js中异步函数调用（保持良好性能）最佳方法">
    
    <link rel="preload" href="/v1/assets/css/0.styles.f88691c4.css" as="style"><link rel="preload" href="/v1/assets/js/app.93a1c734.js" as="script"><link rel="preload" href="/v1/assets/js/2.2eaeb6cd.js" as="script"><link rel="preload" href="/v1/assets/js/3.f94d89fc.js" as="script"><link rel="preload" href="/v1/assets/js/29.45d64603.js" as="script"><link rel="prefetch" href="/v1/assets/js/10.5d42a13c.js"><link rel="prefetch" href="/v1/assets/js/11.faa2cbe0.js"><link rel="prefetch" href="/v1/assets/js/12.c2385ffd.js"><link rel="prefetch" href="/v1/assets/js/13.9796a203.js"><link rel="prefetch" href="/v1/assets/js/14.69cee3bc.js"><link rel="prefetch" href="/v1/assets/js/15.84574b18.js"><link rel="prefetch" href="/v1/assets/js/16.92cfe601.js"><link rel="prefetch" href="/v1/assets/js/17.9017431a.js"><link rel="prefetch" href="/v1/assets/js/18.322b0918.js"><link rel="prefetch" href="/v1/assets/js/19.c310df05.js"><link rel="prefetch" href="/v1/assets/js/20.2849d8cd.js"><link rel="prefetch" href="/v1/assets/js/21.5f446f72.js"><link rel="prefetch" href="/v1/assets/js/22.4da8e7cf.js"><link rel="prefetch" href="/v1/assets/js/23.09fd5336.js"><link rel="prefetch" href="/v1/assets/js/24.6f140176.js"><link rel="prefetch" href="/v1/assets/js/25.c5e4886a.js"><link rel="prefetch" href="/v1/assets/js/26.9ffc96d5.js"><link rel="prefetch" href="/v1/assets/js/27.f9af4141.js"><link rel="prefetch" href="/v1/assets/js/28.f3da97f3.js"><link rel="prefetch" href="/v1/assets/js/30.6c475319.js"><link rel="prefetch" href="/v1/assets/js/31.237a3dd1.js"><link rel="prefetch" href="/v1/assets/js/32.23ad9890.js"><link rel="prefetch" href="/v1/assets/js/33.8e4b9ad1.js"><link rel="prefetch" href="/v1/assets/js/34.fd826f97.js"><link rel="prefetch" href="/v1/assets/js/35.40c1d2a4.js"><link rel="prefetch" href="/v1/assets/js/36.cc9a53ac.js"><link rel="prefetch" href="/v1/assets/js/37.9f36fb35.js"><link rel="prefetch" href="/v1/assets/js/38.68f0c241.js"><link rel="prefetch" href="/v1/assets/js/39.20baf80f.js"><link rel="prefetch" href="/v1/assets/js/4.d944a8e7.js"><link rel="prefetch" href="/v1/assets/js/40.72b1c71c.js"><link rel="prefetch" href="/v1/assets/js/41.59836dd0.js"><link rel="prefetch" href="/v1/assets/js/42.da98654d.js"><link rel="prefetch" href="/v1/assets/js/43.712879c1.js"><link rel="prefetch" href="/v1/assets/js/44.f963778b.js"><link rel="prefetch" href="/v1/assets/js/45.1458ba25.js"><link rel="prefetch" href="/v1/assets/js/46.a4d81a6a.js"><link rel="prefetch" href="/v1/assets/js/47.45292823.js"><link rel="prefetch" href="/v1/assets/js/48.7078d7ff.js"><link rel="prefetch" href="/v1/assets/js/49.1a43378d.js"><link rel="prefetch" href="/v1/assets/js/5.b4f51445.js"><link rel="prefetch" href="/v1/assets/js/50.f42270fe.js"><link rel="prefetch" href="/v1/assets/js/51.94122348.js"><link rel="prefetch" href="/v1/assets/js/52.0b22b89f.js"><link rel="prefetch" href="/v1/assets/js/53.be6cf0d3.js"><link rel="prefetch" href="/v1/assets/js/54.1e9bd091.js"><link rel="prefetch" href="/v1/assets/js/55.8509a0aa.js"><link rel="prefetch" href="/v1/assets/js/56.06a2a4b0.js"><link rel="prefetch" href="/v1/assets/js/57.d6befc86.js"><link rel="prefetch" href="/v1/assets/js/58.58a52084.js"><link rel="prefetch" href="/v1/assets/js/59.d4a7ef3d.js"><link rel="prefetch" href="/v1/assets/js/6.ff65f142.js"><link rel="prefetch" href="/v1/assets/js/60.397bb874.js"><link rel="prefetch" href="/v1/assets/js/61.04c7a2b1.js"><link rel="prefetch" href="/v1/assets/js/62.5f2fa66c.js"><link rel="prefetch" href="/v1/assets/js/63.08563569.js"><link rel="prefetch" href="/v1/assets/js/64.683202f8.js"><link rel="prefetch" href="/v1/assets/js/65.994e4933.js"><link rel="prefetch" href="/v1/assets/js/66.d181bb53.js"><link rel="prefetch" href="/v1/assets/js/67.70db4014.js"><link rel="prefetch" href="/v1/assets/js/68.3377e375.js"><link rel="prefetch" href="/v1/assets/js/69.bbc32937.js"><link rel="prefetch" href="/v1/assets/js/7.251e48f5.js"><link rel="prefetch" href="/v1/assets/js/70.cd94421a.js"><link rel="prefetch" href="/v1/assets/js/71.d9ed3ce4.js"><link rel="prefetch" href="/v1/assets/js/72.3c47c8b2.js"><link rel="prefetch" href="/v1/assets/js/73.9ff4db73.js"><link rel="prefetch" href="/v1/assets/js/74.cbe0c7dc.js"><link rel="prefetch" href="/v1/assets/js/75.bf13e6cc.js"><link rel="prefetch" href="/v1/assets/js/76.4f16823f.js"><link rel="prefetch" href="/v1/assets/js/77.bed0965d.js"><link rel="prefetch" href="/v1/assets/js/78.6951de73.js"><link rel="prefetch" href="/v1/assets/js/8.0e98a616.js"><link rel="prefetch" href="/v1/assets/js/9.94e20e0d.js">
    <link rel="stylesheet" href="/v1/assets/css/0.styles.f88691c4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container dm-xiong-detail"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/v1/" class="home-link router-link-active"><!----> <span class="site-name">熊大</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/v1/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/v1/javascript/" class="nav-link router-link-active">
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/v1/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/v1/webpack/" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/v1/blog/" class="nav-link">
  随笔
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="github" class="dropdown-title"><span class="title">github</span> <span class="arrow down"></span></button> <button type="button" aria-label="github" class="mobile-dropdown-title"><span class="title">github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/maxiong88/emailgfriend" target="_blank" rel="noopener noreferrer" class="nav-link external">
  koa-email
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/v1/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/v1/javascript/" class="nav-link router-link-active">
  javascript
</a></li><li class="dropdown-item"><!----> <a href="/v1/vue/" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/v1/webpack/" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/v1/blog/" class="nav-link">
  随笔
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="github" class="dropdown-title"><span class="title">github</span> <span class="arrow down"></span></button> <button type="button" aria-label="github" class="mobile-dropdown-title"><span class="title">github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/maxiong88/emailgfriend" target="_blank" rel="noopener noreferrer" class="nav-link external">
  koa-email
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>async vs promise</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/v1/javascript/async-vs-promise.html#promises" class="sidebar-link">Promises</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/v1/javascript/async-vs-promise.html#知识点" class="sidebar-link">知识点</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/v1/javascript/async-vs-promise.html#async-定义" class="sidebar-link">async 定义</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/v1/javascript/async-vs-promise.html#async-介绍" class="sidebar-link">async 介绍</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/v1/javascript/async-vs-promise.html#async-await-规则" class="sidebar-link">async/await 规则</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/v1/javascript/async-vs-promise.html#await-命令" class="sidebar-link">await 命令</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/v1/javascript/async-vs-promise.html#async-注意事项" class="sidebar-link">async 注意事项</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/v1/javascript/async-vs-promise.html#当async-await遇上foreach" class="sidebar-link">当async/await遇上forEach</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/v1/javascript/async-vs-promise.html#为什么-async-await更好-案例" class="sidebar-link">为什么 async/await更好----案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/v1/javascript/async-vs-promise.html#case01" class="sidebar-link">case01</a></li><li class="sidebar-sub-header"><a href="/v1/javascript/async-vs-promise.html#case02" class="sidebar-link">case02</a></li></ul></li><li><a href="/v1/javascript/async-vs-promise.html#事件循环对-async-promise性能分析" class="sidebar-link">事件循环对 async promise性能分析</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/v1/javascript/async-vs-promise.html#async-案例" class="sidebar-link">async 案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/v1/javascript/async-vs-promise.html#settimeout" class="sidebar-link">setTimeout</a></li></ul></li><li><a href="/v1/javascript/async-vs-promise.html#参考" class="sidebar-link">参考</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="content__default theme-default-content custom"><h2 id="promises"><a href="#promises" class="header-anchor">#</a> Promises</h2> <p>与传统的基于回调的方法相比，<code>Promise</code>提供了一种更简单的选择。还允许您使用类似同步<code>try/catch</code>的方法来处理异步错误。
promise就是简化了异步流和避免回调地狱，async、await允许我们编写看起来是同步的异步js</p> <ul><li><a href="//dzone.com/articles/java-vs-go-microservices-load-testing-rematch">dzone</a></li> <li><a href="//stackoverflow.com/questions/54347806/questions-on-performance-regarding-async-await-vs-promises-and-the-event-loop">stackoverflow</a></li></ul> <h2 id="知识点"><a href="#知识点" class="header-anchor">#</a> 知识点</h2> <ul><li><a href="/v1/javascript/js-function.html">构造函数</a></li> <li><a href="/v1/javascript/js-promise.html">promise</a></li></ul> <h2 id="async-定义"><a href="#async-定义" class="header-anchor">#</a> async 定义</h2> <ul><li><code>AsyncFunction</code> 不是全局对象。通过<code>AsyncFunction</code>构造函数创建一个<code>async function</code>对象：<code>const AsyncFunction = async function () {}.constructor;</code></li> <li>使用<code>async function expression</code>函数声明方式创建一个<code>async function</code>对象：<code>async function [name](){}</code></li> <li>声明式在代码中调用要比通过构造函数创建的效率要高，因为AsyncFunction构造函数创建的对象将在创建函数时进行解析、声明式是与其他代码一起解析</li></ul> <h2 id="async-介绍"><a href="#async-介绍" class="header-anchor">#</a> async 介绍</h2> <ul><li>是一种编写异步代码的新方法。以前的替代方法是 回调和promise</li> <li>实际上只是在promise之上构建的语法糖（async 返回promise，await是等待解决promise的语法糖）</li> <li>是非阻塞的</li> <li>使异步代码的外观和行为更像同步代码。</li></ul> <h2 id="async-await-规则"><a href="#async-await-规则" class="header-anchor">#</a> async/await 规则</h2> <ul><li><code>async</code>函数返回一个 Promise 对象。必须等到内部所有await命令后面的 Promise 对象执行完，才会发生状态改变，除非遇到return语句或者抛出错误。也就是说，只有async函数内部的异步操作执行完，才会执行then方法指定的回调函数。</li> <li><code>async</code>函数内部return语句返回的值，会成为then方法回调函数的参数。</li> <li><code>async</code>函数内部抛出异常或者是返回reject，都会使函数的promise状态为失败reject。</li> <li>使用async/await时，请确保使用try/catch进行错误处理</li> <li>在循环或迭代器中使用await要小心。并行执行代码可能会出现执行顺序不同</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// &quot;hello world&quot;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'has Error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Error: has Error 2</span>
</code></pre></div><p>上面代码中，函数f内部return命令返回的值，会被then方法回调函数接收到。</p> <h2 id="await-命令"><a href="#await-命令" class="header-anchor">#</a> await 命令</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 等同于</span>
  <span class="token comment">// return 123;</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 123</span>
</code></pre></div><p>如何实现休眠效果</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">interval</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 用法</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">one2FiveInAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">one2FiveInAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="async-注意事项"><a href="#async-注意事项" class="header-anchor">#</a> async 注意事项</h2> <ul><li>await命令后面的Promise对象，运行结果可能是rejected,<code>任何一个await语句后面的 Promise 对象变为reject状态，那么整个async函数都会中断执行。</code>，所以最好把await命令放在<code>try...catch</code>代码块中或者在Promise对象后面增加catch方法;</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">a2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">as2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// 不加catch会中断执行下面方法</span>
    <span class="token keyword">await</span> <span class="token function">a2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">as2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>多个await命令后面的异步操作，如果不存在继发关系，最好让它们同时触发。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">axiosA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">let</span> a1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">let</span> a2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">axiosA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 20秒以后输出1，2</span>
</code></pre></div><p>上面的例子，a1,a2是两个独立的异步，被写成继发关系。这样比较耗时，因为只有a1完成以后，才会执行a2，完全可以让它们同时触发。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">axiosA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">let</span> <span class="token punctuation">[</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 或</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">axiosA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">let</span> a1 <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">let</span> a2 <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	a1 <span class="token operator">=</span> <span class="token keyword">await</span> a1<span class="token punctuation">;</span>
	a2 <span class="token operator">=</span> <span class="token keyword">await</span> a2
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">axiosA1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10秒以后同时输出1，2</span>
</code></pre></div><ul><li><p>await命令只能用在async函数之中，如果用在普通函数，就会报错。</p></li> <li><p>async 函数可以保留运行堆栈。因为等到await执行完毕才会往下执行</p></li></ul> <h2 id="当async-await遇上foreach"><a href="#当async-await遇上foreach" class="header-anchor">#</a> 当async/await遇上forEach</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">dbFuc</span><span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//这里不需要 async</span>
  <span class="token keyword">let</span> docs <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token string">','</span><span class="token operator">+</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">+</span><span class="token string">','</span><span class="token operator">+</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">+</span><span class="token string">','</span><span class="token operator">+</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 可能得到错误结果</span>
  docs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">await</span> doc<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">dbFuc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 1,1571645398094 </span>
<span class="token comment">// 3,1571645399094 </span>
<span class="token comment">// 2,1571645400094 // 并发</span>
</code></pre></div><p>上面代码可能不会正常工作，原因是这时三个db.post操作将是并发执行，也就是同时执行，而不是继发执行。正确的写法是采用for循环。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 继发</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">dbFuc</span><span class="token punctuation">(</span><span class="token parameter">db</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> docs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> doc <span class="token keyword">of</span> docs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="为什么-async-await更好-案例"><a href="#为什么-async-await更好-案例" class="header-anchor">#</a> 为什么 async/await更好----案例</h2> <h3 id="case01"><a href="#case01" class="header-anchor">#</a> case01</h3> <p>假设一个函数getJSON返回一个promise。</p> <p>这就是你如何用promise来实现它</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">makeRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token string">&quot;done&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>使用async/await:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">makeRequest</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token string">&quot;done&quot;</span>
<span class="token punctuation">}</span>
<span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="why-is-it-better"><a href="#why-is-it-better" class="header-anchor">#</a> Why Is It better?</h5> <ul><li>代码简洁！（上面代码避免了嵌套代码）</li> <li>Error handling 错误处理！（使用相同的结构来处理异步、同步错误。使用try/catch，无需使用promise的catch）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// promsie </span>
<span class="token keyword">const</span> <span class="token function-variable function">makeRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// this parse may fail</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// uncomment this block to handle asynchronous errors</span>
      <span class="token comment">// .catch((err) =&gt; {</span>
      <span class="token comment">//   console.log(err)</span>
      <span class="token comment">// })</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// async</span>
<span class="token keyword">const</span> <span class="token function-variable function">makeRequest</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// this parse may fail</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Conditionals ajax条件嵌套/中间值</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// promise</span>
<span class="token keyword">const</span> <span class="token function-variable function">makeRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>needsAnotherRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">makeAnotherRequest</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">moreData</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moreData<span class="token punctuation">)</span>
            <span class="token keyword">return</span> moreData
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> data
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// async</span>
<span class="token keyword">const</span> <span class="token function-variable function">makeRequest</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>needsAnotherRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> moreData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">makeAnotherRequest</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>moreData<span class="token punctuation">)</span>
    <span class="token keyword">return</span> moreData
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">return</span> data
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Error stacks 错误堆栈！</li> <li>更容易调试！（箭头函数）</li> <li>You can await anything 等待延迟同步执行</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 记录api花费时间</span>

<span class="token comment">// promise</span>
<span class="token keyword">const</span> <span class="token function-variable function">recordTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">makeRequest</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timeStart <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// throws error for sync functions (.then is not a function)</span>
    <span class="token keyword">const</span> timeEnd <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'time take:'</span><span class="token punctuation">,</span> timeEnd <span class="token operator">-</span> timeStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// async</span>
<span class="token keyword">const</span> <span class="token function-variable function">recordTime</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">makeRequest</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timeStart <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// works for any sync or async function</span>
  <span class="token keyword">const</span> timeEnd <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'time take:'</span><span class="token punctuation">,</span> timeEnd <span class="token operator">-</span> timeStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="case02"><a href="#case02" class="header-anchor">#</a> case02</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// users to retrieve</span>
<span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">[</span>
<span class="token string">'W8lbAokuirfdlTJpnsNC5kryuHtu1G53'</span><span class="token punctuation">,</span>
<span class="token string">'ZinqxnohbXMQdtF6avtlUkxLLknRxCTh'</span><span class="token punctuation">,</span>
<span class="token string">'ynQePb3RB2JSx4iziGYMM5eXgkwnufS5'</span><span class="token punctuation">,</span>
<span class="token string">'EtT2haq2sNoWnNjmeyZnfUmZn9Ihfi8w'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// array to hold response</span>
<span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// fetch all 4 users and return responses to the response array</span>
<span class="token keyword">function</span> <span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
axios
<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/users/userId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// save the response for user 1</span>
response<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
axios
<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/users/userId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>users<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// save the response for user 2</span>
response<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
axios
<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/users/userId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>users<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// save the response for user 3</span>
response<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
axios
<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/users/userId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>users<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// save the response for user 4</span>
response<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// handle error</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// handle error</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// handle error</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token comment">// handle error</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>哎呀，这很丑陋，并且在代码中占用了大量空间。</p> <p>async/await是JavaScript的最新，最重要的功能，它使我们不仅可以避免回调地狱，还可以确保我们的代码干净并且可以正确捕获错误。 我对Async / Await最为着迷的是，它是基于Promises（非阻塞等）构建的，但仍允许代码被读取和读取，就好像它是同步的一样。 这就是力量所在。</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token comment">// users to retrieve</span>
<span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token punctuation">[</span>
<span class="token string">'W8lbAokuirfdlTJpnsNC5kryuHtu1G53'</span><span class="token punctuation">,</span>
<span class="token string">'ZinqxnohbXMQdtF6avtlUkxLLknRxCTh'</span><span class="token punctuation">,</span>
<span class="token string">'ynQePb3RB2JSx4iziGYMM5eXgkwnufS5'</span><span class="token punctuation">,</span>
<span class="token string">'EtT2haq2sNoWnNjmeyZnfUmZn9Ihfi8w'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// array to hold response</span>
<span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token parameter">users</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
response<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/users/userId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>users<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/users/userId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>users<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/users/userId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>users<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
response<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/users/userId=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>users<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于Async / Await是基于Promises构建的，因此您甚至可以将Promise.all（）与await关键字一起使用：</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user1 <span class="token operator">=</span> <span class="token function">getUser1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> user2 <span class="token operator">=</span> <span class="token function">getUser2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> user3 <span class="token operator">=</span> <span class="token function">getUser3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>user1<span class="token punctuation">,</span> user2<span class="token punctuation">,</span> user3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">注意：</p> <p>Async / await由于其同步特性而稍慢一些。 连续多次使用它时应小心，因为await关键字会停止执行其后的所有代码，与在同步代码中完全一样。</p></div> <h2 id="事件循环对-async-promise性能分析"><a href="#事件循环对-async-promise性能分析" class="header-anchor">#</a> 事件循环对 async promise性能分析</h2> <blockquote><p>处理是否相同 ？？
微任务 ？？
MDN,异步函数返回一个asyncFunction对象，promise没有，asyncFunction有什么好处 ？？
性能如何 ？？</p></blockquote> <h2 id="async-案例"><a href="#async-案例" class="header-anchor">#</a> async 案例</h2> <ul><li>出现报错终止</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">chainAnimationsAsync</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> animations</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> anim <span class="token keyword">of</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ret <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span>anim<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token function">b</span><span class="token punctuation">(</span>anim<span class="token operator">+</span><span class="token string">'错误'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token function">a</span><span class="token punctuation">(</span>anim<span class="token operator">+</span><span class="token string">'成功'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 忽略错误，继续执行 */</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span><span class="token string">'抛出错误'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 2错误 抛出错误  ;Promise {&lt;fulfilled&gt;: &quot;1成功&quot;}</span>
</code></pre></div><ul><li>实现多次重复尝试。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// for while</span>
<span class="token keyword">const</span> superagent <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'superagent'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">NUM_RETRIES</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">NUM_RETRIES</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> superagent<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://google.com/this-throws-an-error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 上面代码中，如果await操作成功，就会使用break语句退出循环；如果失败，会被catch语句捕捉，然后进入下一轮循环。</span>
</code></pre></div><ul><li>如何实现休眠效果</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token parameter">interval</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 用法</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">one2FiveInAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">one2FiveInAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>按顺序完成异步操作</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 继发</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">logInOrder</span><span class="token punctuation">(</span><span class="token parameter">urls</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> url <span class="token keyword">of</span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'@'</span><span class="token operator">+</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> url<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token constant">VM24624</span><span class="token operator">:</span><span class="token number">4</span> <span class="token number">1</span>@<span class="token number">1551346291594</span>
<span class="token constant">VM24624</span><span class="token operator">:</span><span class="token number">4</span> <span class="token number">3</span>@<span class="token number">1551346294595</span>
<span class="token constant">VM24624</span><span class="token operator">:</span><span class="token number">4</span> <span class="token number">2</span>@<span class="token number">1551346296596</span>
<span class="token constant">VM24624</span><span class="token operator">:</span><span class="token number">4</span> <span class="token number">4</span>@<span class="token number">1551346300597</span>
<span class="token constant">VM24624</span><span class="token operator">:</span><span class="token number">4</span> <span class="token number">7</span>@<span class="token number">1551346307599</span>
<span class="token constant">VM24624</span><span class="token operator">:</span><span class="token number">4</span> <span class="token number">6</span>@<span class="token number">1551346313602</span>
<span class="token constant">VM24624</span><span class="token operator">:</span><span class="token number">4</span> <span class="token number">5</span>@<span class="token number">1551346318603</span>
<span class="token constant">VM24624</span><span class="token operator">:</span><span class="token number">4</span> <span class="token number">8</span>@<span class="token number">1551346326605</span>
<span class="token comment">// 并发</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">logInOrder</span><span class="token punctuation">(</span><span class="token parameter">urls</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 并发读取</span>
  <span class="token keyword">const</span> textPromises <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">url</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'@'</span><span class="token operator">+</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> url<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>textPromises<span class="token punctuation">,</span> <span class="token string">'=======11111'</span><span class="token punctuation">)</span>
  <span class="token comment">// 按次序输出</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> textPromise <span class="token keyword">of</span> textPromises<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> textPromise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">logInOrder</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token constant">VM24450</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">1</span>@<span class="token number">1551346111979</span>
<span class="token constant">VM24450</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">3</span>@<span class="token number">1551346113979</span>
<span class="token constant">VM24450</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">2</span>@<span class="token number">1551346112979</span>
<span class="token constant">VM24450</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">4</span>@<span class="token number">1551346114979</span>
<span class="token constant">VM24450</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">7</span>@<span class="token number">1551346117979</span>
<span class="token constant">VM24450</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">6</span>@<span class="token number">1551346116979</span>
<span class="token constant">VM24450</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">5</span>@<span class="token number">1551346115979</span>
<span class="token constant">VM24450</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">8</span>@<span class="token number">1551346118980</span>
</code></pre></div><ul><li>思路：首先按照每次只能并发3个请求的要求，这里就对应A、B、C，当其中有一个请求完之后就会再从urls里面再取出一个进行请求，这样依次类推，直到urls里面的20个请求都执行完才终止请求。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 并发请求函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">concurrencyRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">urls<span class="token punctuation">,</span> maxNum</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>urls<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 下一个请求的下标</span>
        <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 当前请求完成的数量</span>

        <span class="token comment">// 发送请求</span>
        <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> urls<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> i <span class="token operator">=</span> index<span class="token punctuation">;</span> <span class="token comment">// 保存序号，使result和urls相对应</span>
            <span class="token keyword">const</span> url <span class="token operator">=</span> urls<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
            index<span class="token operator">++</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> resp <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// resp 加入到results</span>
                results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> resp<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// err 加入到results</span>
                results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> err<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment">// 判断是否所有的请求都已完成</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> urls<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'完成了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// maxNum和urls.length取最小进行调用</span>
        <span class="token keyword">const</span> times <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>maxNum<span class="token punctuation">,</span> urls<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> times<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    urls<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://jsonplaceholder.typicode.com/todos/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">concurrencyRequest</span><span class="token punctuation">(</span>urls<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// [黑土豆](https://juejin.cn/post/7163522138698153997)</span>
</code></pre></div><ul><li>10 个 Ajax 同时发起请求，全部返回展示结果，并且至多允许三次失败，说出设计思路</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 第一种 继承关系</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">axios</span><span class="token punctuation">(</span><span class="token parameter">urls</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> i<span class="token punctuation">;</span>
    <span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">of</span> urls<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">try</span><span class="token punctuation">{</span>
            arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
                <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token string">'==='</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">||</span> i <span class="token operator">===</span> <span class="token number">4</span> <span class="token operator">||</span> i <span class="token operator">===</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">reject</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token string">'@@'</span><span class="token operator">+</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token string">'@@@'</span><span class="token operator">+</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                    
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
            num <span class="token operator">++</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>num<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>num <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">throw</span><span class="token punctuation">(</span><span class="token string">'错误了三弟'</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> num<span class="token punctuation">)</span>
    <span class="token keyword">return</span> arr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">1</span> <span class="token string">&quot;===&quot;</span>
<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">21</span> <span class="token number">1</span>@@<span class="token number">1551429003656</span> <span class="token number">1</span>
<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">2</span> <span class="token string">&quot;===&quot;</span>
<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">3</span> <span class="token string">&quot;===&quot;</span>
<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">4</span> <span class="token string">&quot;===&quot;</span>
<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">21</span> <span class="token number">4</span>@@<span class="token number">1551429006662</span> <span class="token number">2</span>
<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">5</span> <span class="token string">&quot;===&quot;</span>
<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">6</span> <span class="token string">&quot;===&quot;</span>
<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">7</span> <span class="token string">&quot;===&quot;</span>
<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">10</span> <span class="token number">8</span> <span class="token string">&quot;===&quot;</span>
<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">21</span> <span class="token number">8</span>@@<span class="token number">1551429010669</span> <span class="token number">3</span>
<span class="token constant">VM32383</span><span class="token operator">:</span><span class="token number">29</span> <span class="token function">Uncaught</span> <span class="token punctuation">(</span><span class="token keyword">in</span> promise<span class="token punctuation">)</span> 错误了三弟
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 并发操作</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">logInOrder</span><span class="token punctuation">(</span><span class="token parameter">urls</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> response<span class="token punctuation">;</span>
    <span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> textPromises <span class="token operator">=</span> urls<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">url</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">||</span> url <span class="token operator">===</span> <span class="token number">4</span> <span class="token operator">||</span> url <span class="token operator">===</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">reject</span><span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'@@@'</span><span class="token operator">+</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> url<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token function">resolve</span><span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'@@'</span><span class="token operator">+</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> url<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>textPromises<span class="token punctuation">,</span> <span class="token string">'=======11111'</span><span class="token punctuation">)</span>
    <span class="token comment">// 按次序输出</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> textPromise <span class="token keyword">of</span> textPromises<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> textPromise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">{</span>
            num<span class="token operator">++</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>num <span class="token operator">&gt;=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span><span class="token punctuation">(</span><span class="token string">'抛出3次错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">logInOrder</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token constant">VM32579</span><span class="token operator">:</span><span class="token number">15</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>Promise<span class="token punctuation">,</span> Promise<span class="token punctuation">,</span> Promise<span class="token punctuation">,</span> Promise<span class="token punctuation">,</span> Promise<span class="token punctuation">,</span> Promise<span class="token punctuation">,</span> Promise<span class="token punctuation">,</span> Promise<span class="token punctuation">]</span> <span class="token string">&quot;=======11111&quot;</span>
    <span class="token number">0</span><span class="token operator">:</span> Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>rejected<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token string">&quot;1@@@1571646981511&quot;</span><span class="token punctuation">}</span>
    <span class="token number">1</span><span class="token operator">:</span> Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>resolved<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token string">&quot;3@@1571646983510&quot;</span><span class="token punctuation">}</span>
    <span class="token number">2</span><span class="token operator">:</span> Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>resolved<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token string">&quot;2@@1571646982511&quot;</span><span class="token punctuation">}</span>
    <span class="token number">3</span><span class="token operator">:</span> Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span>
    <span class="token number">4</span><span class="token operator">:</span> Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span>
    <span class="token number">5</span><span class="token operator">:</span> Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span>
    <span class="token number">6</span><span class="token operator">:</span> Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span>
    <span class="token number">7</span><span class="token operator">:</span> Promise <span class="token punctuation">{</span><span class="token operator">&lt;</span>pending<span class="token operator">&gt;</span><span class="token punctuation">}</span>
<span class="token constant">VM4668</span><span class="token operator">:</span><span class="token number">22</span> <span class="token number">1</span>
<span class="token constant">VM4668</span><span class="token operator">:</span><span class="token number">19</span> <span class="token number">3</span>@@<span class="token number">1571646983510</span>
<span class="token constant">VM4668</span><span class="token operator">:</span><span class="token number">19</span> <span class="token number">2</span>@@<span class="token number">1571646982511</span>
<span class="token constant">VM4668</span><span class="token operator">:</span><span class="token number">22</span> <span class="token number">2</span>
<span class="token constant">VM4668</span><span class="token operator">:</span><span class="token number">19</span> <span class="token number">7</span>@@<span class="token number">1571646987510</span>
<span class="token constant">VM4668</span><span class="token operator">:</span><span class="token number">19</span> <span class="token number">6</span>@@<span class="token number">1571646986511</span>
<span class="token constant">VM4668</span><span class="token operator">:</span><span class="token number">19</span> <span class="token number">5</span>@@<span class="token number">1571646985510</span>
<span class="token constant">VM4668</span><span class="token operator">:</span><span class="token number">22</span> <span class="token number">3</span>
<span class="token constant">VM32579</span><span class="token operator">:</span><span class="token number">25</span> <span class="token function">Uncaught</span> <span class="token punctuation">(</span><span class="token keyword">in</span> promise<span class="token punctuation">)</span> <span class="token string">'抛出3次错误'</span>

</code></pre></div><h3 id="settimeout"><a href="#settimeout" class="header-anchor">#</a> setTimeout</h3> <p>setTimeout不是一个async函数，所以你不能在ES7 async-await中使用它。但您可以sleep使用ES6 Promise实现您的功能：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sleep</span> <span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1,3,2</span>
</code></pre></div><h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://tc39.es/ecmascript-asyncawait/#async-function-definitions" target="_blank" rel="noopener noreferrer">https://tc39.es/ecmascript-asyncawait/#async-function-definitions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>;</li></ul></div> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/v1/javascript/" class="prev router-link-active">
        /javascript/
      </a></span> <span class="next"><a href="/v1/javascript/" class="router-link-active">
        /javascript/
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/v1/assets/js/app.93a1c734.js" defer></script><script src="/v1/assets/js/2.2eaeb6cd.js" defer></script><script src="/v1/assets/js/3.f94d89fc.js" defer></script><script src="/v1/assets/js/29.45d64603.js" defer></script>
  </body>
</html>
